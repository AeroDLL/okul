<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dijital Aile Danışmanı v1.5</title> <style>
        /* --- TEMEL ARAYÜZ STİLLERİ --- */
        :root { /* Renk Değişkenleri */
             /* ... (Renk değişkenleri aynı) ... */
             --bg-color: #f4f7f6; --container-bg: #fff; --text-color: #333; --header-bg: #007bff;
             --header-text: #fff; --user-msg-bg: #007bff; --user-msg-text: #fff;
             --bot-msg-bg: #e9ecef; --bot-msg-text: #333; --input-area-bg: #f9f9f9;
             --input-border: #ccc; --button-bg: #007bff; --button-text: #fff;
             --button-hover: #0056b3; --disabled-button: #aaa; --link-color: #007bff;
             --footer-text: #888; --shadow-color: rgba(0,0,0,0.05); --popup-header-bg: #007bff;
             --popup-header-text: #fff; --popup-bg: #fff; --popup-border: #ddd;
             --popup-shadow: rgba(0,0,0,0.15); --info-text-color: #6c757d;
             --icon-button-color: #6c757d; --icon-button-hover: #343a40;
             --timestamp-color: #999; /* Yeni: Zaman damgası rengi */
             --scroll-button-bg: rgba(0, 123, 255, 0.7); /* Yeni: Aşağı kaydırma butonu */
             --scroll-button-hover: rgba(0, 86, 179, 0.9);
        }
        body { /* ... (body stili aynı) ... */ }
        #chat-container { /* ... (chat-container stili aynı) ... */ }
        #header { /* ... (header stili aynı) ... */ }
        #header-title h3 { /* ... */ } #header-title p { /* ... */ }
        .header-buttons { /* ... */ } .header-button { /* ... */ }
        .header-button:hover { /* ... */ }
        #messages { /* ... (messages stili aynı) ... */ }
        .message-wrapper { /* ... (message-wrapper stili aynı) ... */ }
        .message-wrapper.user { /* ... */ } .message-wrapper.bot { /* ... */ }
        .message { /* ... (message stili aynı) ... */ }
        .message strong { /* ... */ } .message a { /* ... */ } .message a:hover { /* ... */ }
        .user-message { /* ... (user-message stili aynı) ... */ }
        .bot-message { /* ... (bot-message stili aynı) ... */ }

        /* --- YENİ: Zaman Damgası Stili --- */
        .timestamp {
            font-size: 0.7em;
            color: var(--timestamp-color);
            margin-top: 3px;
            display: block; /* Yeni satırda görünmesi için */
            text-align: right; /* Sağa yasla */
        }
        .user-message + .timestamp { text-align: right; margin-right: 5px;} /* Kullanıcı mesajı için sağa */
        .bot-message + .timestamp { text-align: left; margin-left: 5px;}   /* Bot mesajı için sola */
        /* ------------------------------- */

        .message-actions { /* Geri bildirim butonları kaldırıldı */
            display: flex; align-items: center; gap: 8px; margin-top: 5px;
            margin-left: 10px; opacity: 0; transition: opacity 0.3s;
            height: 0; overflow: hidden;
        }
        .message-wrapper:hover .message-actions { opacity: 1; height: auto; }
        .action-button { /* Stil güncellendi */
            border: none; background: none; color: var(--icon-button-color);
            font-size: 1.2em; /* İkon biraz büyüdü */
            cursor: pointer; padding: 2px 6px;
            border-radius: 5px; transition: background 0.2s, color 0.2s;
        }
        .action-button:hover { background: #f1f1f1; color: var(--icon-button-hover); }
        .copy-status { font-size: 0.9em; color: #2c7; margin-left: 3px; }

        /* --- YENİ: Yazıyor... Animasyonu --- */
        .loading span {
            display: inline-block;
            animation: typing-dot 1.4s infinite;
            animation-delay: 0s;
            margin: 0 1px;
            width: 5px; height: 5px; background-color: currentColor; border-radius: 50%;
        }
        .loading span:nth-child(2) { animation-delay: 0.2s; }
        .loading span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-dot {
            0% { transform: translateY(0); }
            20% { transform: translateY(-3px); }
            40% { transform: translateY(0); }
        }
        /* ---------------------------------- */
        .loading { /* Loading metnini kaldır */ color: var(--footer-text); font-style: normal; }

        #input-area { /* ... (input-area stili aynı) ... */ }
        #message-input { /* ... (message-input stili aynı) ... */ }
        /* Yeni: Input kilitliyken görünüm */
        #message-input:disabled {
             background-color: #eee; cursor: not-allowed; opacity: 0.7;
        }
        #send-button { /* ... (send-button stili aynı) ... */ }
        #send-button:hover { /* ... */ } #send-button:disabled { /* ... */ }
        #features-popup { /* ... (popup stilleri aynı) ... */ }
        #popup-header { /* ... */ } #popup-header h4 { /* ... */ } #popup-close { /* ... */ }
        #popup-close:hover { /* ... */ } #popup-content { /* ... */ }
        #popup-content ul { /* Liste stili v1.1 gibi */ } #popup-content li { /* ... */ }
        @keyframes slideUp { /* ... */ }
        .footer-credit { /* ... (footer stili aynı) ... */ }

        /* --- YENİ: Aşağı Kaydırma Butonu Stili --- */
        #scroll-to-bottom {
            position: fixed;
            bottom: 80px; /* Popup'ın biraz üstünde */
            right: 30px;
            width: 40px; height: 40px;
            background-color: var(--scroll-button-bg);
            color: white;
            border: none; border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: none; /* Başlangıçta gizli */
            align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s, opacity 0.3s;
            opacity: 0;
            z-index: 990;
        }
        #scroll-to-bottom.visible { display: flex; opacity: 1; }
        #scroll-to-bottom:hover { background-color: var(--scroll-button-hover); }
        /* -------------------------------------- */

        body.dark-mode { /* Karanlık Mod Stilleri */
             /* ... (Karanlık Mod renkleri aynı) ... */
             --bg-color: #24292e; --container-bg: #171b20; --text-color: #f3f3f3;
            --header-bg: #23272e; --header-text: #f3f3f3; --user-msg-bg: #3749a4;
            --user-msg-text: #fff; --bot-msg-bg: #343a40; --bot-msg-text: #f3f3f3;
            --input-area-bg: #23272e; --input-border: #444; --button-bg: #3749a4;
            --button-text: #fff; --button-hover: #2c3e80; --disabled-button: #555;
            --link-color: #5aa9fd; --footer-text: #aaa; --popup-header-bg: #23272e;
            --popup-header-text: #f3f3f3; --popup-bg: #1c2128; --popup-border: #444;
            --popup-shadow: rgba(0,0,0,0.33); --info-text-color: #e5e5e5;
             --timestamp-color: #888; /* Koyu tema zaman damgası */
             --icon-button-color: #aaa; --icon-button-hover: #fff;
             --scroll-button-bg: rgba(55, 73, 164, 0.8);
             --scroll-button-hover: rgba(44, 62, 128, 1);
        }
        /* Koyu modda input kilitleme */
         body.dark-mode #message-input:disabled { background-color: #333; }
        /* Koyu modda buton hover */
         body.dark-mode .action-button:hover,
         body.dark-mode .feedback-button:hover { background: #555; }

        .info-note { /* ... (info-note stili aynı) ... */ }
    </style>
</head>
<body>

    <div id="chat-container">
        <div id="header">
            <div id="header-title">
                <h3>Dijital Aile Danışmanı</h3>
                <p>UYARI: Bu bir demo projedir.</p>
            </div>
            <div class="header-buttons">
                 <button id="clear-chat" class="header-button" title="Sohbeti Temizle">🗑️</button>
                 <button id="feature-popup-btn" class="header-button" title="Özellikler">✨</button>
                 <button id="theme-toggle" class="header-button" title="Temayı Değiştir">🌙</button>
            </div>
        </div>
        <div id="messages">
             </div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="Sorunuzu yazın..." autocomplete="off">
            <button id="send-button">➤</button>
        </div>
    </div>

    <p class="info-note">
        Not: Ücretsiz sunucu kullanıldığı için ilk yanıt biraz gecikebilir. Anlayışınız için teşekkürler.
    </p>

    <div id="features-popup">
        <div> <div id="popup-header">
                 <h4>🌟 Proje Özellikleri (v1.5)</h4> <button id="popup-close">×</button>
             </div>
             <div id="popup-content">
                  <ul> <li>🎨 Karanlık Mod Desteği</li>
                      <li>💬 **"Yazıyor..."** Animasyonu</li>
                      <li>🕒 **Mesaj Zaman Damgaları**</li>
                      <li>🖱️ **Aşağı Kaydırma Butonu**</li>
                      <li>🔒 **Gelişmiş Yükleme Durumu** (Input Kilitleme)</li>
                      <li>📋 Mesaj Kopyalama Butonu</li>
                      <li>🗑️ Sohbet Temizleme Butonu</li>
                      <li>🔗 Tıklanabilir Yönlendirme Linkleri</li>
                      <li>🧠 Geliştirilmiş Gemini API Motoru (Daha Empatik & Odaklı)</li>
                      <li>🕊️ Etik Güvenlik Filtresi (ALO 183/112/155)</li>
                      <li>🗣️ Duygusal Ton Algılama & Duygu Takibi</li>
                      <li>🔒 Veri Gizliliği Garantisi (Kayıt Tutmaz)</li>
                      <li>🧩 Spesifik Uzman Yönlendirme</li>
                      <li>📝 Kalın Yazı & Paragraf Desteği</li>
                      <li>📊 Aile İstatistik Panosu (Gelecek Özellik)</li>
                      <li>🛠️ **İstemci Hata Kayıt Sistemi** (Admin İçin)</li>
                      </ul>
             </div>
        </div>
    </div>

    <div class="footer-credit">
        Yapımcı: Emirhan Bıçakcı ✨
    </div>
    <button id="scroll-to-bottom" title="En Alta Git">↓</button>
    <script>
        const messagesDiv = document.getElementById('messages');
        const inputField = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const popup = document.getElementById('features-popup');
        const popupBtn = document.getElementById('feature-popup-btn');
        const popupCloseBtn = document.getElementById('popup-close');
        const themeToggleButton = document.getElementById('theme-toggle');
        const clearChatBtn = document.getElementById('clear-chat');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom'); // Yeni buton
        const API_URL = 'https://okul-api.onrender.com/api/mesaj';
        const ERROR_LOG_URL = 'https://okul-api.onrender.com/api/log_error'; // Yeni Hata Loglama URL'i

        // --- YENİ: Hata Loglama Fonksiyonu ---
        async function logClientError(error) {
            console.error('İstemci Hatası:', error); // Konsola da yazdır
            try {
                await fetch(ERROR_LOG_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                         message: error.message || 'Bilinmeyen istemci hatası',
                         details: error.stack || error.toString() // Hatanın detayını gönder
                     })
                });
            } catch (logError) {
                console.error('Hata loglanırken hata oluştu:', logError);
            }
        }
        // ------------------------------------

        // --- sendMessage GÜNCELLENDİ (Input Kilitleme, Hata Loglama) ---
        async function sendMessage() {
            const messageText = inputField.value.trim();
            if (messageText === '' || sendButton.disabled) return;

            addMessageToUI(messageText, 'user');
            inputField.value = '';
            inputField.blur();
            sendButton.disabled = true;
            inputField.disabled = true; // Input'u da kilitle

            // Öneri butonları varsa gizle (bu kodda yok ama gelecekte eklenebilir)
            // if (suggestedTopicsDiv) suggestedTopicsDiv.style.display = 'none';

            const loadingDivWrapper = addMessageToUI('', 'bot', true); // Boş metinle çağır
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mesaj: messageText }) });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ hata: 'Sunucu geçersiz yanıt verdi.' }));
                    throw new Error(errorData.hata || 'Sunucu hatası oluştu: ' + response.status);
                }
                const data = await response.json();
                loadingDivWrapper.remove(); // Yükleniyor mesajını kaldır
                if(data.cevap) { addMessageToUI(data.cevap, 'bot'); }
                else { addMessageToUI(data.hata || "Bilinmeyen bir hata.", 'bot'); }

            } catch (error) { // Hem fetch hatası hem de sunucu hatası buraya düşer
                loadingDivWrapper.remove();
                let errorMessage = "Üzgünüm, bir hata oluştu. Lütfen daha sonra tekrar deneyin.";
                if (error && error.message) { errorMessage = error.message; }
                addMessageToUI(errorMessage, 'bot');
                logClientError(error); // Yakalanan hatayı logla
            } finally {
                sendButton.disabled = false;
                inputField.disabled = false; // Input kilidini aç
                // inputField.focus(); // Klavye kapalı kalsın
            }
        }
        // -----------------------------------------------------------

        // --- addMessageToUI GÜNCELLENDİ (Yazıyor..., Zaman Damgası) ---
        function addMessageToUI(text, type, isLoading = false) {
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = `message-wrapper ${type}`;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            if (isLoading) {
                messageDiv.classList.add('loading');
                // Yazıyor animasyonu
                messageDiv.innerHTML = '<span></span><span></span><span></span>';
                wrapperDiv.appendChild(messageDiv);
            } else {
                // Markdown -> HTML çevirici
                let safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                safeText = safeText.replace(/\n/g, '<br>');
                safeText = safeText.replace(/\[(.*?)\]\((https?:\/\/[^\s\)]+|tel:[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
                messageDiv.innerHTML = safeText;
                wrapperDiv.appendChild(messageDiv);

                // Zaman Damgası Ekle
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'timestamp';
                timestampSpan.textContent = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                // Mesajın altına değil, wrapper'ın altına ekleyelim ki hizalama kolay olsun
                wrapperDiv.appendChild(timestampSpan);

                // Sadece BOT mesajlarına Kopyala butonunu ekle (Geri bildirim kaldırıldı)
                if (type === 'bot') {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    const copyButton = document.createElement('button');
                    copyButton.className = 'action-button copy-button';
                    copyButton.innerHTML = '📋 <span class="copy-status"></span>';
                    copyButton.title = 'Mesajı Kopyala';
                    copyButton.onclick = (event) => { /* ... (Kopyalama kodu aynı) ... */
                        navigator.clipboard.writeText(text).then(() => {
                        const statusSpan = event.currentTarget.querySelector('.copy-status'); statusSpan.textContent = ' Kopyalandı!';
                        setTimeout(() => { statusSpan.textContent = ''; }, 2000); }).catch(err => {
                            console.error('Kopyalama hatası:', err); logClientError(err); // Kopyalama hatasını da logla
                        });
                    };
                    actionsDiv.appendChild(copyButton);
                    // Geri bildirim butonları kaldırıldı
                    wrapperDiv.appendChild(actionsDiv);
                }
            }

            messagesDiv.appendChild(wrapperDiv);
            // Yeni mesaj gelince veya yazıyor göstergesi çıkınca en alta kaydır
            messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });

            // Scroll butonunu kontrol et
            checkScrollButtonVisibility();

            return wrapperDiv; // Loading mesajını silmek için
        }
        // --------------------------------------------------------------

        // --- Geri Bildirim Fonksiyonu KALDIRILDI ---
        // function handleFeedback(buttonElement, type) { ... }

        // --- Sohbet Temizleme Fonksiyonu (Aynı) ---
        function clearChat() { /* ... */
             messagesDiv.innerHTML = ''; showWelcome(); inputField.focus();
             checkScrollButtonVisibility(); // Temizleyince butonu gizle
         }

        // --- Tema Fonksiyonları (Aynı) ---
        function toggleTheme() { /* ... */ }
        function applySavedTheme() { /* ... */ }

        // --- Popup Fonksiyonları (Aynı) ---
        function openPopup() { popup.classList.add('active'); }
        function closePopup() { popup.classList.remove('active'); localStorage.setItem('features-popup-seen', 'yes'); }

        // --- YENİ: Aşağı Kaydırma Butonu Fonksiyonları ---
        function scrollToBottom() {
            messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
        }

        function checkScrollButtonVisibility() {
            // Eğer mesajlar div'i yukarı kaydırılmışsa ve taşma varsa butonu göster
            if (messagesDiv.scrollHeight > messagesDiv.clientHeight &&
                messagesDiv.scrollTop < (messagesDiv.scrollHeight - messagesDiv.clientHeight - 100)) { // 100px tolerans
                scrollToBottomBtn.classList.add('visible');
            } else {
                scrollToBottomBtn.classList.remove('visible');
            }
        }
        // ---------------------------------------------

        // --- Event Listener'lar ---
        inputField.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !sendButton.disabled) { sendMessage(); } });
        sendButton.onclick = sendMessage; // Buton click
        clearChatBtn.onclick = clearChat;
        themeToggleButton.onclick = toggleTheme;
        popupBtn.onclick = openPopup;
        popupCloseBtn.onclick = closePopup;
        scrollToBottomBtn.onclick = scrollToBottom; // Yeni buton click
        messagesDiv.addEventListener('scroll', checkScrollButtonVisibility); // Kaydırmayı dinle
        popup.addEventListener('click', function(e) { // Popup dışına tıklayınca kapat
            if (e.target === popup) closePopup(); });

        // --- Sayfa Yüklenince ---
        function showWelcome() { // İlk mesajı ekleme fonksiyonu
             addMessageToUI("Merhaba! Ben Dijital Aile Danışmanıyım. Size sadece psikolojik, pedagojik ve hukuki aile konularında rehberlik edebilirim.", 'bot');
        }
        window.addEventListener('load', function () {
            applySavedTheme();
            showWelcome(); // İlk mesajı göster
            if (localStorage.getItem('features-popup-seen') !== 'yes') {
                 setTimeout(openPopup, 2000); // Popup'ı gecikmeli aç
            }
            checkScrollButtonVisibility(); // Başlangıçta kontrol et
        });

        // --- Genel Tarayıcı Hatalarını Yakalama (İsteğe Bağlı ama Önerilir) ---
        window.onerror = function(message, source, lineno, colno, error) {
            logClientError({ message: `Global Hata: ${message}`, details: `${source} L:${lineno} C:${colno}`, stack: error ? error.stack : 'N/A' });
            return true; // Tarayıcının varsayılan hata konsolunu engelleme
        };
        window.onunhandledrejection = function(event) {
            logClientError({ message: 'İşlenmeyen Promise Reddi', details: event.reason ? event.reason.toString() : 'N/A', stack: event.reason && event.reason.stack ? event.reason.stack : 'N/A' });
        };
        // --------------------------------------------------------------------

    </script>

</body>
</html>
